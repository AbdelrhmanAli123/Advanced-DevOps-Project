pipeline{
    agent any

    environment {
        aws_access_key_id     = credentials('aws_access_key_id')
        aws_secret_access_key = credentials('aws_secret_access_key')
        image_name            = "devops-task:${BUILD_NUMBER}"
        region                = "us-east-2"
        ecr_repo_name         = "my-ecr"
        ecr_url               = ""
        image_version         = "${ecr_url}/${ecr_repo_name}:${BUILD_NUMBER}"
    }
    stages{


        stage('checkout the repo'){
            steps{
                git branch: 'main', credentialsId: 'github_cred', url: 'https://github.com/AbdelrhmanAli123/advanced-devops-task.git'
            }
        }
        stage('build the image'){
            steps{
                script{
                        sh 'docker build -t ${image_name}'
                }
            }
        }
        stage('push image to ECR'){
            steps{
                script{
                        sh 'aws ecr-public get-login-password --region ${region} | docker login --username AWS --password-stdin ${ecr_url}'
                        sh 'docker tag ${image_name} ${ecr_url}/${ecr_repo_name}:${BUILD_NUMBER}'
                        sh 'docker push ${ecr_url}/${ecr_repo_name}:${BUILD_NUMBER}'
                }
            }
        }
        stage('terraform apply or destroy'){
            steps{
                build(job: 'cd-pipeline', parameters: [
                    string(name: 'IMAGE_VERSION', value: "${image_version}")
                ])
            }
        }
    }
}